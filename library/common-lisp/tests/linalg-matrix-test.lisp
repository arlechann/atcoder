(in-package :cl-user)

(defpackage :linalg-matrix-test
  (:use :cl :rove))
(in-package :linalg-matrix-test)

(defun mat->lists (m)
  (loop for i from 0 below (linalg.matrix:matrix-row m)
        collect (loop for j from 0 below (linalg.matrix:matrix-column m)
                      collect (linalg.matrix:matrix-ref m i j))))

(defun vec->list (v)
  (loop for i from 0 below (linalg.vector:vector-dimension v)
        collect (linalg.vector:vector-ref v i)))

(deftest linalg-matrix-basic
  (let ((m (linalg.matrix:matrix '(1 2) '(3 4))))
    (ok (linalg.matrix:matrixp m))
    (ok (equal '(2 2) (linalg.matrix:matrix-shape m)))
    (ok (= 4 (linalg.matrix:matrix-element-count m)))
    (ok (= 1 (linalg.matrix:matrix-ref m 0 0)))
    (ok (= 2 (linalg.matrix:matrix-row-major-ref m 1)))
    (setf (linalg.matrix:matrix-ref m 1 0) 9)
    (ok (= 9 (linalg.matrix:matrix-ref m 1 0)))
    (setf (linalg.matrix:matrix-row-major-ref m 3) 7)
    (ok (= 7 (linalg.matrix:matrix-ref m 1 1)))))

(deftest linalg-matrix-row-column-vector
  (let* ((m (linalg.matrix:matrix '(1 2 3) '(4 5 6)))
         (rv (linalg.matrix:matrix-row-vector m 1))
         (cv (linalg.matrix:matrix-column-vector m 2)))
    (ok (equal '(4 5 6) (coerce rv 'list)))
    (ok (equal '(3 6) (vec->list cv)))
    (setf (aref rv 0) 40)
    (ok (= 40 (linalg.matrix:matrix-ref m 1 0)))))

(deftest linalg-matrix-arithmetic
  (let ((a (linalg.matrix:matrix '(1 2) '(3 4)))
        (b (linalg.matrix:matrix '(10 20) '(30 40))))
    (ok (equal '((11 22) (33 44))
               (mat->lists (linalg.matrix:matrix+ a b))))
    (ok (equal '((-9 -18) (-27 -36))
               (mat->lists (linalg.matrix:matrix- a b))))
    (ok (equal '((-1 -2) (-3 -4))
               (mat->lists (linalg.matrix:matrix- a))))
    (ok (equal '((2 4) (6 8))
               (mat->lists (linalg.matrix:matrix-scalar-multiply a 2))))
    (let ((m1 (linalg.matrix:matrix '(1 2) '(3 4))))
      (linalg.matrix:matrix-add! m1 (linalg.matrix:matrix '(1 1) '(1 1)))
      (ok (equal '((2 3) (4 5)) (mat->lists m1)))
      (linalg.matrix:matrix-sub! m1 (linalg.matrix:matrix '(1 1) '(1 1)))
      (ok (equal '((1 2) (3 4)) (mat->lists m1)))
      (linalg.matrix:matrix-scale! m1 2 3)
      (ok (equal '((6 12) (18 24)) (mat->lists m1))))))

(deftest linalg-matrix-product-family
  (let* ((a (linalg.matrix:matrix '(1 2 3) '(4 5 6)))
         (b (linalg.matrix:matrix '(7 8) '(9 10) '(11 12)))
         (p (linalg.matrix:matrix-product a b)))
    (ok (equal '((58 64) (139 154)) (mat->lists p)))
    (ok (equal '((1 4) (2 5) (3 6))
               (mat->lists (linalg.matrix:matrix-transpose a)))))
  (let* ((m (linalg.matrix:matrix '(1 2) '(3 4)))
         (v (linalg.vector:vector 10 20)))
    (ok (equal '(50 110)
               (vec->list (linalg.matrix:matrix-vector-product m v))))
    (ok (equal '(70 100)
               (vec->list (linalg.matrix:vector-matrix-product v m)))))
  (ok (equal '((3 4 5) (6 8 10))
             (mat->lists (linalg.matrix:outer-product
                          (linalg.vector:vector 1 2)
                          (linalg.vector:vector 3 4 5))))))

(deftest linalg-matrix-properties
  (let ((i3 (linalg.matrix:make-identity-matrix 3))
        (z (linalg.matrix:make-zero-matrix 2 3))
        (m (linalg.matrix:matrix '(1 2 3) '(4 5 6) '(7 8 9))))
    (ok (linalg.matrix:identity-matrix-p i3))
    (ok (not (linalg.matrix:identity-matrix-p m)))
    (ok (linalg.matrix:zero-matrix-p z))
    (ok (not (linalg.matrix:zero-matrix-p m)))
    (ok (= 15 (linalg.matrix:matrix-trace m)))
    (ok (equal '(1 5 9) (vec->list (linalg.matrix:matrix-diagonal m))))
    (setf (linalg.matrix:matrix-diagonal m) (linalg.vector:vector 9 8 7))
    (ok (equal '(9 8 7) (vec->list (linalg.matrix:matrix-diagonal m))))
    (ok (utility.number:approx= (sqrt 372)
                                (linalg.matrix:matrix-frobenius-norm m)
                                :eps 1e-6))))

(deftest linalg-matrix-power-and-conversion
  (let* ((m (linalg.matrix:matrix '(1 1) '(1 0)))
         (m5 (linalg.matrix:matrix-power m 5)))
    (ok (equal '((8 5) (5 3)) (mat->lists m5))))
  (let ((v (linalg.vector:vector 1 2 3)))
    (ok (equal '((1 2 3))
               (mat->lists (linalg.matrix:vector->row-matrix v))))
    (ok (equal '((1) (2) (3))
               (mat->lists (linalg.matrix:vector->column-matrix v))))))

(deftest linalg-matrix-errors
  (ok (handler-case (progn (linalg.matrix:matrix+ (linalg.matrix:matrix '(1 2))
                                                  (linalg.matrix:matrix '(1 2) '(3 4)))
                           nil)
        (error () t)))
  (ok (handler-case (progn (linalg.matrix:matrix-product (linalg.matrix:matrix '(1 2))
                                                         (linalg.matrix:matrix '(1 2)))
                           nil)
        (error () t)))
  (ok (handler-case (progn (linalg.matrix:matrix-trace (linalg.matrix:matrix '(1 2 3)))
                           nil)
        (error () t)))
  (ok (handler-case (progn (setf (linalg.matrix:matrix-diagonal
                                  (linalg.matrix:matrix '(1 2) '(3 4)))
                                 (linalg.vector:vector 1))
                           nil)
        (error () t)))
  (ok (handler-case (progn (linalg.matrix:matrix-power (linalg.matrix:matrix '(1 2)) -1)
                           nil)
        (error () t))))
