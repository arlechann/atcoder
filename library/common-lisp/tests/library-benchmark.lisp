(in-package :cl-user)

(require :asdf)
(pushnew (truename "library/common-lisp/") asdf:*central-registry* :test #'equal)
(asdf:load-system "atcoder-library-core")

(defun classify-match (x)
  (match:match x
    ((list 0 _) :zero-first)
    ((match::guard (list a b) (> a b)) :descending-pair)
    ((list _ _) :pair)
    (otherwise :other)))

(defun classify-cond (x)
  (cond ((and (consp x)
              (consp (cdr x))
              (null (cddr x))
              (eql (car x) 0))
         :zero-first)
        ((and (consp x)
              (consp (cdr x))
              (null (cddr x))
              (> (car x) (cadr x)))
         :descending-pair)
        ((and (consp x)
              (consp (cdr x))
              (null (cddr x)))
         :pair)
        (t :other)))

(defun bench (fn data rounds)
  (let* ((start (get-internal-real-time))
         (acc 0))
    (dotimes (r rounds)
      (dolist (x data)
        (when (eq (funcall fn x) :descending-pair)
          (incf acc))))
    (values (/ (- (get-internal-real-time) start)
               internal-time-units-per-second)
            acc)))

(defun run-benchmark (&key (n 20000) (rounds 80))
  (let ((data (loop for i from 0 below n
                    collect (list (mod i 11)
                                  (mod (+ i 7) 13)))))
    (format t "n=~D rounds=~D~%" n rounds)
    (multiple-value-bind (tm am) (bench #'classify-match data rounds)
      (multiple-value-bind (tc ac) (bench #'classify-cond data rounds)
        (format t "match: ~,6Fs (acc=~D)~%" tm am)
        (format t "cond : ~,6Fs (acc=~D)~%" tc ac)
        (when (> tc 0)
          (format t "ratio(match/cond)=~,3F~%" (/ tm tc)))))))

(run-benchmark)
